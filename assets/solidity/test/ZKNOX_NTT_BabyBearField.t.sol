/**
 *
 */
/*ZZZZZZZZZZZZZZZZZZZKKKKKKKKK    KKKKKKKNNNNNNNN        NNNNNNNN     OOOOOOOOO     XXXXXXX       XXXXXXX                         ..../&@&#.       .###%@@@#, ..                         
/*Z:::::::::::::::::ZK:::::::K    K:::::KN:::::::N       N::::::N   OO:::::::::OO   X:::::X       X:::::X                      ...(@@* .... .           &#//%@@&,.                       
/*Z:::::::::::::::::ZK:::::::K    K:::::KN::::::::N      N::::::N OO:::::::::::::OO X:::::X       X:::::X                    ..*@@.........              .@#%%(%&@&..                    
/*Z:::ZZZZZZZZ:::::Z K:::::::K   K::::::KN:::::::::N     N::::::NO:::::::OOO:::::::OX::::::X     X::::::X                   .*@( ........ .  .&@@@@.      .@%%%%%#&@@.                  
/*ZZZZZ     Z:::::Z  KK::::::K  K:::::KKKN::::::::::N    N::::::NO::::::O   O::::::OXXX:::::X   X::::::XX                ...&@ ......... .  &.     .@      /@%%%%%%&@@#                  
/*        Z:::::Z      K:::::K K:::::K   N:::::::::::N   N::::::NO:::::O     O:::::O   X:::::X X:::::X                   ..@( .......... .  &.     ,&      /@%%%%&&&&@@@.              
/*       Z:::::Z       K::::::K:::::K    N:::::::N::::N  N::::::NO:::::O     O:::::O    X:::::X:::::X                   ..&% ...........     .@%(#@#      ,@%%%%&&&&&@@@%.               
/*      Z:::::Z        K:::::::::::K     N::::::N N::::N N::::::NO:::::O     O:::::O     X:::::::::X                   ..,@ ............                 *@%%%&%&&&&&&@@@.               
/*     Z:::::Z         K:::::::::::K     N::::::N  N::::N:::::::NO:::::O     O:::::O     X:::::::::X                  ..(@ .............             ,#@&&&&&&&&&&&&@@@@*               
/*    Z:::::Z          K::::::K:::::K    N::::::N   N:::::::::::NO:::::O     O:::::O    X:::::X:::::X                   .*@..............  . ..,(%&@@&&&&&&&&&&&&&&&&@@@@,               
/*   Z:::::Z           K:::::K K:::::K   N::::::N    N::::::::::NO:::::O     O:::::O   X:::::X X:::::X                 ...&#............. *@@&&&&&&&&&&&&&&&&&&&&@@&@@@@&                
/*ZZZ:::::Z     ZZZZZKK::::::K  K:::::KKKN::::::N     N:::::::::NO::::::O   O::::::OXXX:::::X   X::::::XX               ...@/.......... *@@@@. ,@@.  &@&&&&&&@@@@@@@@@@@.               
/*Z::::::ZZZZZZZZ:::ZK:::::::K   K::::::KN::::::N      N::::::::NO:::::::OOO:::::::OX::::::X     X::::::X               ....&#..........@@@, *@@&&&@% .@@@@@@@@@@@@@@@&                  
/*Z:::::::::::::::::ZK:::::::K    K:::::KN::::::N       N:::::::N OO:::::::::::::OO X:::::X       X:::::X                ....*@.,......,@@@...@@@@@@&..%@@@@@@@@@@@@@/                   
/*Z:::::::::::::::::ZK:::::::K    K:::::KN::::::N        N::::::N   OO:::::::::OO   X:::::X       X:::::X                   ...*@,,.....%@@@,.........%@@@@@@@@@@@@(                     
/*ZZZZZZZZZZZZZZZZZZZKKKKKKKKK    KKKKKKKNNNNNNNN         NNNNNNN     OOOOOOOOO     XXXXXXX       XXXXXXX                      ...&@,....*@@@@@ ..,@@@@@@@@@@@@@&.                     
/*                                                                                                                                   ....,(&@@&..,,,/@&#*. .                             
/*                                                                                                                                    ......(&.,.,,/&@,.                                
/*                                                                                                                                      .....,%*.,*@%                               
/*                                                                                                                                    .#@@@&(&@*,,*@@%,..                               
/*                                                                                                                                    .##,,,**$.,,*@@@@@%.                               
/*                                                                                                                                     *(%%&&@(,,**@@@@@&                              
/*                                                                                                                                      . .  .#@((@@(*,**                                
/*                                                                                                                                             . (*. .                                   
/*                                                                                                                                              .*/
///* Copyright (C) 2025 - Renaud Dubois, Simon Masson - This file is part of ZKNOX project
///* License: This software is licensed under MIT License
///* This Code may be reused including this header, license and copyright notice.
///* See LICENSE file at the root folder of the project.
///* FILE: ZKNOX_NTT_BabyBearField.t.sol
///* Description: Test file for ZKNOX_NTT BabyBear field implementation
/**
 *
 */
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.25;

import {Test, console} from "forge-std/Test.sol";

import "../src/ZKNOX_NTT.sol";

//only for bench
contract NTTTest is Test {
    // File generated using ../pythonref/scripts/generate_test_vectors_solidity.py

    //exemple of stateless initialisation, no external contract provided
    ZKNOX_NTT ntt = new ZKNOX_NTT(address(0), address(0), 2013265921, 2005401601);
    // forgefmt: disable-next-line
    uint256[256]  psi_rev = [1, 284861408, 211723194, 1592366214, 1934320121, 1446056615, 196396260, 612986503, 451973565, 772607190, 1399190761, 1273220281, 1253260071, 889310574, 588889032, 1835875777, 1333217202, 328902512, 1724976031, 1141518129, 939236864, 1171812390, 1351065666, 918899846, 1941224298, 1721589904, 602251207, 686375053, 1957706687, 406991886, 95586718, 492152090, 1964161403, 235470082, 223231138, 23215881, 1594590875, 112574482, 717205599, 465591760, 1491681022, 782913119, 1274926174, 1700600734, 1824115795, 156720578, 132263909, 787294362, 538704769, 1091445674, 397765732, 554679511, 7658004, 1553007845, 1410131110, 1192577619, 1238851905, 912838049, 465770369, 850926282, 544217376, 784229619, 533223002, 632005205, 184201817, 1682376658, 1467656730, 1319549233, 871478870, 993707905, 1481952135, 1696563825, 1829967362, 238789043, 1084539453, 776161080, 582026550, 587815148, 110965872, 912367292, 1222665977, 46459047, 1050632275, 905629977, 1765190681, 1089565990, 1101686277, 195422490, 856866068, 219624526, 653926008, 401423760, 1319662041, 1453957774, 512246112, 340222871, 1306647885, 532061447, 1868042710, 1134936783, 1732600167, 565387341, 337843911, 967916413, 919403943, 238307585, 834684902, 630736300, 566566526, 1227468989, 702101935, 1422331819, 967052682, 1288100093, 1391257054, 79020822, 1337919487, 1560005336, 367148769, 144808788, 171472309, 1705576440, 278567984, 1296157798, 247018910, 23671793, 1034693672, 1159345101, 16303300, 1312408731, 48601359, 1637321720, 1828889379, 1894741346, 971835916, 1817459975, 648310687, 247608396, 446497382, 499191403, 1471171080, 1489739020, 217063694, 1694511695, 1040346932, 1458654649, 1445297234, 1121491039, 1361635720, 1137846698, 500320476, 1594073968, 1000130369, 152531954, 312493468, 1480888359, 1690440436, 1072187526, 387089745, 955088864, 1452112566, 1651123459, 1260838569, 1479559300, 1967436205, 60222659, 1098589615, 1214352228, 1009148102, 1779171120, 929105609, 212597403, 506893846, 646509327, 1537189756, 1836561861, 246465063, 1984600303, 1452434999, 1151641261, 63788306, 467611061, 957344008, 151590722, 633021876, 1496573916, 1947940162, 347997613, 1741454723, 1645637339, 242033074, 297485602, 1318972766, 1392435941, 614517289, 340017354, 1468908220, 1446820157, 1188041066, 950321114, 1753498361, 1119836042, 1701668849, 602504937, 328034906, 1737761431, 1223962526, 1173666668, 1397122709, 849624638, 1336637787, 468145086, 821873058, 853026644, 1491193515, 1922447922, 370291313, 1027907695, 851601029, 403949616, 1370897881, 53576782, 1193296344, 554029437, 1750265429, 1854920421, 1266592989, 470508934, 983783494, 1815204430, 1223429502, 1709024775, 1887204546, 1489450621, 1017905375, 1279203298, 1745735301, 364665014, 61564083, 90122987, 825263949, 47754187, 1136790769, 1238135095, 650381673, 949217896, 992414313, 804607908, 1822130809, 116472350, 1817307375, 1628335437, 1003192097, 1371888568, 1742771357, 499211237];
    // forgefmt: disable-next-line
    uint256[256]  psi_inv_rev = [1, 1728404513, 420899707, 1801542727, 1400279418, 1816869661, 567209306, 78945800, 177390144, 1424376889, 1123955347, 760005850, 740045640, 614075160, 1240658731, 1561292356, 1521113831, 1917679203, 1606274035, 55559234, 1326890868, 1411014714, 291676017, 72041623, 1094366075, 662200255, 841453531, 1074029057, 871747792, 288289890, 1684363409, 680048719, 1381260716, 1480042919, 1229036302, 1469048545, 1162339639, 1547495552, 1100427872, 774414016, 820688302, 603134811, 460258076, 2005607917, 1458586410, 1615500189, 921820247, 1474561152, 1225971559, 1881002012, 1856545343, 189150126, 312665187, 738339747, 1230352802, 521584899, 1547674161, 1296060322, 1900691439, 418675046, 1990050040, 1790034783, 1777795839, 49104518, 853920820, 978572249, 1989594128, 1766247011, 717108123, 1734697937, 307689481, 1841793612, 1868457133, 1646117152, 453260585, 675346434, 1934245099, 622008867, 725165828, 1046213239, 590934102, 1311163986, 785796932, 1446699395, 1382529621, 1178581019, 1774958336, 1093861978, 1045349508, 1675422010, 1447878580, 280665754, 878329138, 145223211, 1481204474, 706618036, 1673043050, 1501019809, 559308147, 693603880, 1611842161, 1359339913, 1793641395, 1156399853, 1817843431, 911579644, 923699931, 248075240, 1107635944, 962633646, 1966806874, 790599944, 1100898629, 1902300049, 1425450773, 1431239371, 1237104841, 928726468, 1774476878, 183298559, 316702096, 531313786, 1019558016, 1141787051, 693716688, 545609191, 330889263, 1829064104, 1514054684, 270494564, 641377353, 1010073824, 384930484, 195958546, 1896793571, 191135112, 1208658013, 1020851608, 1064048025, 1362884248, 775130826, 876475152, 1965511734, 1188001972, 1923142934, 1951701838, 1648600907, 267530620, 734062623, 995360546, 523815300, 126061375, 304241146, 789836419, 198061491, 1029482427, 1542756987, 746672932, 158345500, 263000492, 1459236484, 819969577, 1959689139, 642368040, 1609316305, 1161664892, 985358226, 1642974608, 90817999, 522072406, 1160239277, 1191392863, 1545120835, 676628134, 1163641283, 616143212, 839599253, 789303395, 275504490, 1685231015, 1410760984, 311597072, 893429879, 259767560, 1062944807, 825224855, 566445764, 544357701, 1673248567, 1398748632, 620829980, 694293155, 1715780319, 1771232847, 367628582, 271811198, 1665268308, 65325759, 516692005, 1380244045, 1861675199, 1055921913, 1545654860, 1949477615, 861624660, 560830922, 28665618, 1766800858, 176704060, 476076165, 1366756594, 1506372075, 1800668518, 1084160312, 234094801, 1004117819, 798913693, 914676306, 1953043262, 45829716, 533706621, 752427352, 362142462, 561153355, 1058177057, 1626176176, 941078395, 322825485, 532377562, 1700772453, 1860733967, 1013135552, 419191953, 1512945445, 875419223, 651630201, 891774882, 567968687, 554611272, 972918989, 318754226, 1796202227, 523526901, 542094841, 1514074518, 1566768539, 1765657525, 1364955234, 195805946, 1041430005, 118524575, 184376542, 375944201, 1964664562, 700857190, 1996962621];

    uint256 constant q = 2013265921; // babybear field
    uint256 nm1modq = 2005401601; //256^-1 mod q

    //exemple of stateful initialisation, no external contract provided
    function setUp() public {
        console.log("q=%d, n=%d", q, psi_rev.length);

        bytes memory bytecode_psirev = abi.encodePacked(psi_rev);

        address a_psirev; //address of the precomputations bytecode contract
        a_psirev = address(uint160(0xcaca)); //here it is etched, use create in the future
        vm.etch(a_psirev, bytecode_psirev); //pushing psirev bytecode into contract todo : replace with create

        bytes memory bytecode_psiInvrev = abi.encodePacked(psi_inv_rev);

        address a_psiInvrev; //address of the precomputations bytecode contract
        a_psiInvrev = address(uint160(0xa5a5)); //here it is etched, use create in the future
        vm.etch(a_psiInvrev, bytecode_psiInvrev); //pushing psirev bytecode into contract todo : replace with create

        ntt.update(a_psirev, a_psiInvrev, q, nm1modq); //update ntt with outer contract
    }

    // f and its ntt; using ../pythonref/scripts/generate_test_vectors_solidity.py
    uint256[] f = [
        uint256(1312080942),
        1571571069,
        1088240164,
        1643105958,
        1484026286,
        792531995,
        1259052375,
        18859837,
        1929978005,
        826930048,
        1804544840,
        334827392,
        1705306280,
        780289309,
        163773130,
        65532332,
        678405674,
        510194194,
        1704725877,
        120463628,
        1923545533,
        82473052,
        1415461005,
        82714665,
        995363244,
        382332060,
        1201418110,
        4341215,
        357623828,
        1727160963,
        1525767767,
        178692966,
        1084965238,
        1713888054,
        508593152,
        171938282,
        1701534480,
        1221238968,
        1347081854,
        1968698727,
        881075699,
        1510619580,
        1052165037,
        1261539497,
        1042365097,
        396761460,
        341775427,
        413554514,
        1022132461,
        1302631759,
        18619264,
        1032909204,
        311868181,
        751172631,
        1381820829,
        1185165736,
        1003421300,
        1852695601,
        960383929,
        201102311,
        1169599237,
        1076292335,
        1579208130,
        1144182891,
        1165790454,
        390932160,
        1667229016,
        1722679611,
        1583205772,
        1463937993,
        992152069,
        1340435774,
        662492448,
        166842102,
        806203346,
        1131227176,
        1193619813,
        711336992,
        1200635559,
        1234418250,
        713384953,
        1215246633,
        1150486386,
        1420101113,
        61394885,
        352102334,
        1387720838,
        165187350,
        864552590,
        1116645346,
        713688655,
        1108449375,
        1128673062,
        1756345657,
        1420625086,
        488552336,
        579067471,
        552972562,
        1310824649,
        1636112091,
        2008866559,
        1427276359,
        491501506,
        381280293,
        1370234949,
        758448203,
        402187257,
        1978979288,
        741656557,
        1493982908,
        1143715184,
        1817666708,
        1601481813,
        1870193786,
        1352968194,
        879419450,
        1024396485,
        1570064355,
        1122055868,
        1122914601,
        1504035143,
        399663302,
        447319252,
        679139930,
        1353393933,
        1702424844,
        1597353423,
        1398455935,
        1323290388,
        1761198529,
        1340683799,
        393341759,
        1198073271,
        121914119,
        366280756,
        153432603,
        1661580118,
        1360122756,
        1776374762,
        152517503,
        1046916248,
        1889206794,
        1096745413,
        139174901,
        776464427,
        1887101879,
        1122565406,
        1117909296,
        484288455,
        1903395851,
        10814760,
        647011697,
        499887051,
        679201329,
        1632681996,
        1223234363,
        1148498141,
        1608509394,
        881501424,
        1817264313,
        911413229,
        231425255,
        1606836282,
        530741264,
        208093704,
        1020275702,
        1338738488,
        1761499696,
        831025786,
        1573589563,
        503585791,
        333999690,
        1305124589,
        1188785664,
        537035823,
        96606601,
        455572723,
        1849153376,
        844946149,
        1181365827,
        1591429213,
        1482596110,
        1155623958,
        1537758159,
        826198636,
        683821969,
        607104695,
        1754442376,
        1530095779,
        560032374,
        913747658,
        444713898,
        1799630719,
        81108181,
        1824488173,
        563926119,
        688954625,
        1558086368,
        1115158801,
        596558942,
        843769868,
        1565642427,
        1405636193,
        431914094,
        1050917780,
        63866509,
        777183371,
        101990541,
        596030270,
        695297435,
        1612031564,
        499708615,
        886898531,
        1540618085,
        1333610128,
        225808451,
        772352855,
        1471832778,
        1644463030,
        139504997,
        1338605788,
        291534044,
        265145801,
        1600240057,
        1879895441,
        1905453647,
        66655867,
        1597638167,
        1507917676,
        1077753606,
        137538644,
        1488708765,
        55813325,
        160564105,
        1793575477,
        899375623,
        682523366,
        1210759416,
        692106959,
        313135588,
        522295407,
        1778322082,
        446340910,
        538295052,
        633169509,
        1213388006,
        1348199799,
        1225514479,
        1210834245,
        1218925768,
        1981138177,
        1825791440,
        648950906,
        1062312484,
        1444820933,
        1055058905
    ];
    uint256[] f_ntt = [
        uint256(1717950650),
        1404047666,
        640709476,
        476040925,
        670876761,
        216572875,
        130251501,
        1570921770,
        296011468,
        919798461,
        427275997,
        589687578,
        74532731,
        1953221568,
        925125908,
        165184451,
        1234508373,
        1512922858,
        118333481,
        861792974,
        919561603,
        1895193803,
        178731615,
        1379806933,
        764284229,
        1014315338,
        1453203802,
        87304370,
        724131811,
        1158729168,
        1102399759,
        446293086,
        162460025,
        1624699002,
        1162505458,
        1036109126,
        9368882,
        674992101,
        280388508,
        1975980110,
        1598626292,
        359694593,
        1949230463,
        929322131,
        1702422117,
        68144748,
        892782590,
        426446920,
        565391375,
        521567862,
        1109531016,
        1754871535,
        1666413651,
        1405441221,
        561146995,
        871822968,
        1263680507,
        1966220854,
        1675580826,
        445516563,
        1551123718,
        114228282,
        409184550,
        272196589,
        356565943,
        1077354461,
        1729994640,
        599692040,
        1505937633,
        485425094,
        1946520562,
        1718730988,
        423788111,
        1199235566,
        201687870,
        1853440474,
        54430069,
        1616423477,
        1038593936,
        64387085,
        784505009,
        1888754488,
        1307197091,
        492092591,
        1638256886,
        1311946450,
        1179885794,
        931685397,
        278099300,
        1929386769,
        1582120871,
        1444998678,
        1727491415,
        1071512069,
        1398951002,
        1576318564,
        1289424889,
        1675037128,
        977527146,
        1584747679,
        1899560155,
        20855637,
        846661797,
        1337955431,
        1167671288,
        1237261622,
        601013625,
        909273454,
        1526301607,
        755461552,
        1290407566,
        747361439,
        1555068351,
        559008451,
        2004742392,
        999978207,
        1638864056,
        589253578,
        405099242,
        325225839,
        15654755,
        1571762762,
        1309807417,
        266966226,
        812415166,
        214371139,
        159714058,
        903854364,
        1668496206,
        1463886929,
        868867754,
        2006248902,
        1920250592,
        360450461,
        138321048,
        933205967,
        674939150,
        658457689,
        1706994918,
        638611298,
        579402709,
        827775824,
        1220288148,
        646661308,
        1168267348,
        1967184588,
        1687803682,
        1395556817,
        1113666073,
        312362780,
        827489742,
        1626016282,
        1876626603,
        1452241526,
        479467306,
        81767864,
        1605404222,
        1609280166,
        1503402760,
        123747436,
        1388878383,
        1256789269,
        169914919,
        736796236,
        954750520,
        172063699,
        1363188315,
        1181157410,
        699646935,
        175316990,
        112988994,
        530519834,
        1276760342,
        914454665,
        20123298,
        1956440580,
        981922232,
        1844108486,
        1923487390,
        135019935,
        769350242,
        519422945,
        1886996980,
        296726448,
        1246015389,
        1613839715,
        77214016,
        696220122,
        739539504,
        1293211030,
        1935948958,
        1929851515,
        1528198876,
        1047937484,
        1100273575,
        436966523,
        604911134,
        688323054,
        493289739,
        941339201,
        1929736387,
        1647670150,
        728854559,
        1936136503,
        525886780,
        683677174,
        1171753098,
        1511013080,
        1111330874,
        939767805,
        1524795659,
        1950871207,
        877636591,
        555456560,
        1236746601,
        190853836,
        1851710773,
        1127825056,
        1593135637,
        1974722621,
        203326691,
        702560122,
        165717953,
        1080467041,
        1350987068,
        1936738727,
        1147525306,
        735124527,
        1915167102,
        729453204,
        42371963,
        1671779340,
        1642027578,
        1922522963,
        663450254,
        1960506141,
        1864888440,
        227983120,
        527513719,
        179441645,
        934647871,
        1264862899,
        1416339088,
        1860894242,
        51097437,
        4416965,
        1351686004,
        491511737,
        1371325553,
        200047884,
        1893485007,
        26171102,
        1752005907,
        182254218,
        1259659887,
        1155494610
    ];

    function test_NTTFW() public view {
        uint256 n = 256;
        uint256[] memory fntt = ntt.ZKNOX_NTTFW(f, ntt.o_psirev());
        for (uint256 i = 0; i < n; i++) {
            assertEq(fntt[i], f_ntt[i]);
        }
    }

    function test_NTTINV() public view {
        uint256[] memory res = ntt.ZKNOX_NTTINV(f_ntt, ntt.o_psi_inv_rev());
        uint256 n = 256;
        for (uint256 i = 0; i < n; i++) {
            assertEq(res[i], f[i]);
        }
    }
}
